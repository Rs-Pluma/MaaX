<script setup lang="ts">
import { NButton, NCheckbox, NFormItem } from 'naive-ui'
import { inject, ref } from 'vue'

import MallSelect from '../MallSelect.vue'
import type { GetConfig } from './types'

const showModal = ref(false)

type MallConfig = GetConfig<'Mall'>

const props = defineProps<{
  configurations: MallConfig
  taskIndex: number
}>()

const updateTaskConfigurations = inject('update:configuration') as (
  key: string,
  value: any,
  index: number
) => void
const configurationDisabled = inject('configurationDisabled') as {
  re: boolean
  nre: boolean
}

function handleUpdateConfiguration(key: string, value: any) {
  updateTaskConfigurations(key, value, props.taskIndex)
}

function handleItemUpdate(items: { buy_first: string[]; blacklist: string[] }) {
  for (const [key, list] of Object.entries(items)) {
    handleUpdateConfiguration(key, list)
  }
}
</script>

<template>
  <div class="configuration-form">
    <NFormItem size="small" label-align="left" label-placement="left" :show-feedback="false">
      <NCheckbox
        :disabled="configurationDisabled.nre"
        :checked="props.configurations.shopping"
        @update:checked="checked => handleUpdateConfiguration('shopping', checked)"
      >
        自动购物
      </NCheckbox>
    </NFormItem>

    <NFormItem size="small" label-align="left" label-placement="left" :show-feedback="false">
      <NCheckbox
        :disabled="configurationDisabled.nre"
        :checked="props.configurations.force_shopping_if_credit_full"
        @update:checked="
          checked => handleUpdateConfiguration('force_shopping_if_credit_full', checked)
        "
      >
        信用溢出时无视黑名单
      </NCheckbox>
    </NFormItem>

    <NFormItem
      :show-label="false"
      size="small"
      label-align="left"
      label-placement="left"
      :show-feedback="false"
    >
      <NButton
        quaternary
        type="primary"
        :focusable="false"
        :disabled="configurationDisabled.nre"
        @click="showModal = true"
      >
        管理购买选项...
      </NButton>
      <MallSelect
        v-model:show="showModal"
        :buy_first="props.configurations.buy_first"
        :blacklist="props.configurations.blacklist"
        @update:item="handleItemUpdate"
      />
    </NFormItem>
  </div>
</template>

<style lang="less" scoped>
.mall-configuration {
  text-align: left;
}

.item-group {
  display: flex;
  align-items: center;
}
</style>
